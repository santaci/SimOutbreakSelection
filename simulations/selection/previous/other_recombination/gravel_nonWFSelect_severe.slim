// nonWF selection-driven bottleneck after Gravel model with two chromosomes

initialize() {
	//setSeed(1694628549537);
	initializeSLiMModelType("nonWF");
	initializeSLiMOptions(keepPedigrees=T);
	initializeTreeSeq();
	defineConstant("simID", getSeed());
	if (exists("slimgui")) {
		defineConstant("O", "nonWF_select_"+simID+".trees");
		defineConstant("I", 1);
		defineConstant("gravel",1600280212760);
	}
	initializeMutationType("m1", 0.5, "f", 0.0);
	m1.convertToSubstitution = T;
	initializeGenomicElementType("g1", m1, 1.0);
	initializeGenomicElement(g1, 0, 99329961);
	initializeMutationRate(0);
	
// Read combined HapMap for chr21 and chr22
	
	lines = readFile("/home/users/cindy/recombination_map.TRANSPOSED.combined.txt");
	ends = asInteger(strsplit(lines[0]));
	rates = asFloat(strsplit(lines[1]));
	initializeRecombinationRate(rates, ends);}


// WF-like reproduction - systematically returns to K and prints the ID of the designated parents
reproduction() {
	K = sim.getValue("K");
	for (i in seqLen(K))
	{
		firstParent = p2.sampleIndividuals(1);
		secondParent = p2.sampleIndividuals(1, exclude=firstParent);
		p2.addCrossed(firstParent, secondParent);
		
		//writeFile("nwf_all_patGeno_" + I + ".csv", paste(c(sim.generation,firstParent.pedigreeID,firstParent.countOfMutationsOfType(m1)), "\t"), append=T);
		//writeFile("nwf_all_patGeno_" + I + ".csv", paste(c(sim.generation,secondParent.pedigreeID,secondParent.countOfMutationsOfType(m1)),"\t"), append=T);
	}
	self.active = 0;
}

58000 early() {
	//sim.readFromPopulationFile("/home/users/cindy/data/Gravel/finalGravel_2444438607978.trees");
	sim.readFromPopulationFile("/home/users/cindy/data/Gravel/finalGravel_1640447705818.trees");	
	sim.setValue("K", p2.individualCount);
}

58000 late(){
	mut = sim.mutations;
	catn(mut);
}

// Non-overlapping generations
early()
{
	inds = sim.subpopulations.individuals;
	inds[inds.age > 0].fitnessScaling = 0.0;
	off = inds[inds.age < 1];
	writeFile("nwf_mated_parents_" + I + ".csv", paste(c(sim.generation,off.pedigreeParentIDs),"\t"), append=T);
	writeFile("nwf_mated_offspring_" + I + ".csv", paste(c(sim.generation,off.pedigreeID),"\t"), append=T);

}

// Reduce fitness of individuals without the allele
58002:58003 early() {
	inds = sim.subpopulations.individuals;
	inds[inds.countOfMutationsOfType(m1)<2].fitnessScaling = 0.1;
	inds[inds.age > 0].fitnessScaling = 0.0;
}

// Positive selection is introduced
58002 early() {
	sim.mutations.setSelectionCoeff(0.0);
}

// Positive selection is turned off
58004 early() {
	sim.mutations.setSelectionCoeff(0.0);
}

// Output per generation - prints out to file the final parents of each remaining offspring
58000:58022 late() {
	sim.treeSeqRememberIndividuals(p2.individuals);
	freq = sim.mutationFrequencies(p2);
	inds = sim.subpopulations.individuals;
	off = inds[inds.age < 1];
	patsize = size(unique(off.pedigreeParentIDs));
	wt = size(inds[inds.countOfMutationsOfType(m1) == 0]);
	het = size(inds[inds.countOfMutationsOfType(m1) == 1]);
	hom = size(inds[inds.countOfMutationsOfType(m1) == 2]);
	catn(sim.generation + "\t" + p2.individualCount + "\t" + sim.mutationFrequencies(p2) + "\t" + wt + "\t" + het + "\t" + hom +  "\t" + mean(p2.cachedFitness(inds[inds.countOfMutationsOfType(m1) == 0].index)) + "\t" + mean(p2.cachedFitness(inds[inds.countOfMutationsOfType(m1) == 1].index)) + "\t" + mean(p2.cachedFitness(inds[inds.countOfMutationsOfType(m1) == 2].index)) + "\t" + patsize);
	writeFile("nwf_survivor_parents_" + I + ".csv", paste(c(sim.generation,off.pedigreeParentIDs),"\t"), append=T);
	writeFile("nwf_putparents_" + I + ".csv", paste(c(sim.generation+1,off.pedigreeID),"\t"), append=T);
	writeFile("nwf_putparents_" + I + ".csv", paste(c(sim.generation+1+"g",off.countOfMutationsOfType(m1)),"\t"), append=T);
}

// Tree output
58022 late() {
	sim.treeSeqOutput("/home/users/cindy/data/nonWF_select_" + I + "_gen2.trees");
	//sim.treeSeqOutput("/home/users/cindy/data/toy_data/nonWF_select_" + I + ".trees");
	
}
